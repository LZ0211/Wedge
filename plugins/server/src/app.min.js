"use strict";function init(){function t(t){var e="<div class='child'>"+t+"</div>",n=document.createElement("div");return n.innerHTML=e,n.firstChild}function e(t,e){for(var n=0;n<t.length;n++)e(t[n],n,t)}function n(t,e){return function(n){var n=n||window.event,o=n.target||n.srcElement,i=o.tagName.toLowerCase();if(Array.isArray(t)){if(~t.indexOf(i))return e(o)}else if(i==t.toLowerCase())return e(o)}}function o(){e(arguments,function(t){return t.style.display="block"})}function i(){e(arguments,function(t){return t.style.display="none"})}function r(){[].forEach.call(arguments,function(t){"none"===t.style.display?t.style.display="block":t.style.display="none"})}function c(){o(E.tool,E.home,U.option,U.top,U.add),i(E.index,E.chapter,E.list,U.prev,U.next,U.index,U.home),C="home"}function a(){o(E.tool,E.index,U.home,U.top),i(E.home,E.chapter,E.list,U.index,U.prev,U.next,U.option,U.add),C="index"}function l(){o(E.tool,E.chapter,U.prev,U.next,U.index,U.home,U.top),i(E.home,E.index,E.list,U.option,U.add),C="chapter"}function u(){o(E.tool,E.list,U.prev,U.next,U.index,U.home,U.top),i(E.home,E.index,U.option,E.chapter,U.add),C="list"}function s(t,e,n){if(t=""+t,t.length>=n)return t;for(var o=t.length;o<n;o++)t=e+t;return t}function d(t,e){var n=new Date(t),o=e||"yyyy-MM-dd";return o=o.replace(/(y+)/,function(t,e){return s(n.getFullYear(),0,e.length)}),o=o.replace(/(M+)/,function(t,e){return s(n.getMonth()+1,0,e.length)}),o=o.replace(/(d+)/,function(t,e){return s(n.getDate(),0,e.length)}),o=o.replace(/(h+)/,function(t,e){return s(n.getHours(),0,e.length)}),o=o.replace(/(m+)/,function(t,e){return s(n.getMinutes(),0,e.length)}),o=o.replace(/(s+)/,function(t,e){return s(n.getSeconds(),0,e.length)})}function f(t){o(E.overlay);var e=setTimeout(function(){i(E.overlay)},5e3),n=t();if(n&&n.then)return n.then(function(){i(E.overlay),clearTimeout(e)});i(E.overlay),clearTimeout(e)}function h(t){H=t.sort(N),E.bookList.innerHTML=t.map(function(t){return'<li class="book-li"><div class="book-layout" uuid="'+t.uuid+'"><img src="/cover/'+t.uuid+'" class="book-cover" alt="'+t.title+'" uuid="'+t.uuid+'"><div class="book-cell"><div class="book-title-x"><h2 class="book-title" uuid="'+t.uuid+'">'+t.title+'</h2><span class="book-date">'+d(t.date)+'</span></div><div class="book-author">作者：'+t.author+'</div><div class="book-classes">分类：'+t.classes+'</div><div class="book-status">更新状态：'+(t.isend?"完结":"连载")+"</div></div></li>"}).join(""),E.home.scrollTop=0}function p(){E.bookMeta.innerHTML='<div class="book-layout" uuid="'+M.meta.uuid+'"><img src="/cover/'+M.meta.uuid+'" class="book-cover"><div class="book-cell"><div class="book-title-x"><h2 class="book-title">'+M.meta.title+'</h2><span class="book-date">'+d(M.meta.date)+'</span></div><div class="book-author">作者：'+M.meta.author+'</div><div class="book-classes">分类：'+M.meta.classes+'</div><div class="book-status">更新状态：'+(M.meta.isend?"完结":"连载")+'</div></div></div><div class="book-brief"><p>'+M.meta.brief.replace(/\n/g,"</p><p>")+"</p></div>",E.listCounts.innerText="共"+M.list.length+"章",E.listRule.innerText="倒序",E.listContent.innerHTML=M.list.map(function(t){return'<li cid="'+t.id+'">'+t.title+"</li>"}).join(""),E.chapterList.innerHTML=M.list.map(function(t){return'<li cid="'+t.id+'">'+t.title+"</li>"}).join(""),E.index.scrollTop=0}function b(){function t(t,n){var o=t.innerText,i=n[o];if(i){if("tab tab-selected"==t.className&&H.length==i.length)return U.option.click();e(E.TagStatus.querySelectorAll("label"),function(t){return t.className="tab"}),e(E.TagClasses.querySelectorAll("label"),function(t){return t.className="tab"}),e(E.TagTimes.querySelectorAll("label"),function(t){return t.className="tab"}),t.className="tab tab-selected",h(i),U.option.click()}}var o=j.concat(),i={"全部":o},r={"全部":o,"完结":[],"连载":[]},c={"全部":o,"一日内":[],"一周内":[],"一月内":[],"半年内":[],"半年外":[]},a=Date.now();j.forEach(function(t){t.classes in i?i[t.classes].push(t):i[t.classes]=[t],t.status=t.isend?"完结":"连载",r[t.status].push(t);var e=a-t.date;e<864e5?(c["一日内"].push(t),c["一周内"].push(t),c["一月内"].push(t),c["半年内"].push(t)):e<6048e5?(c["一周内"].push(t),c["一月内"].push(t),c["半年内"].push(t)):e<2592e6?(c["一月内"].push(t),c["半年内"].push(t)):e<15552e6?c["半年内"].push(t):c["半年外"].push(t)}),E.TagClasses.innerHTML=Object.keys(i).map(function(t){return'<label class="tab">'+t+"</label>"}).join(""),E.TagStatus.innerHTML=Object.keys(r).map(function(t){return'<label class="tab">'+t+"</label>"}).join(""),E.TagTimes.innerHTML=Object.keys(c).map(function(t){return'<label class="tab">'+t+"</label>"}).join(""),E.TagClasses.querySelector("label").className="tab tab-selected",E.TagClasses.onclick=n("label",function(e){return t(e,i)}),E.TagStatus.onclick=n("label",function(e){return t(e,r)}),E.TagTimes.onclick=n("label",function(e){return t(e,c)})}function m(t){E.chapterContainer.innerHTML='<h3 class="chapter-title" cid="'+t.id+'">'+t.title+'</h3><div class="chapter-content"><p>'+t.content.replace(/\n/g,"</p><p>")+"</p></div>"}function v(e){document.createDocumentFragment(),E.chapterContainer.appendChild(t('<h3 class="chapter-title" cid="'+e.id+'">'+e.title+"</h3>")),E.chapterContainer.appendChild(t('<div class="chapter-content"><p>'+e.content.replace(/\n/g,"</p><p>")+"</p></div>"))}function k(t){var n=y(t);if(-1!=n&&!(n<=A)){A=n;var o=E.chapterList.querySelectorAll("li");return e(o,function(t){return t.className=""}),o[n].className="selected",fetch("/chapter/"+M.meta.uuid+"/"+t).then(function(t){return t.json()}).then(function(e){R=t,A=y(R),console.log(A),v(e),q.set(M.meta.uuid,t)}).then(function(){return setTimeout(S(A,E.chapter.scrollHeight,E.chapter.clientHeight),100)})}}function g(t,e){if(!e&&M&&M.meta.uuid==t){var n=q.get(M.meta.uuid);return n?T(n):(a(),void(E.index.scrollTop=0))}f(function(){var n=e?{cache:"reload"}:{};return fetch("/book/"+t,n).then(function(t){return t.json()}).then(function(t){M=t,M.list.sort(function(t,e){return t.id-e.id}),p();var n=q.get(M.meta.uuid);if(n&&!e)return T(n);a(),E.index.scrollTop=0})})}function T(t){var n=y(t);if(-1!=n){var o=E.chapterList.querySelectorAll("li");return e(o,function(t){return t.className=""}),o[n].className="selected",fetch("/chapter/"+M.meta.uuid+"/"+t).then(function(t){return t.json()}).then(function(e){R=t,A=y(R),m(e),l(),E.chapter.scrollTop=0,q.set(M.meta.uuid,t)}).then(function(){return setTimeout(S(A,E.chapter.scrollHeight,E.chapter.clientHeight),100)})}}function y(t){for(var e=M.list,n=0,o=e.length-1;n<=o;){var i=Math.floor((o+n)/2);if(e[i].id==t)return i;if(e[i].id-t<0)n=i+1;else{if(!(e[i].id-t>0))return-1;o=i-1}}}function x(){var t=E.chapterList.querySelector(".selected");E.list.scrollTop=t.offsetTop-E.list.clientHeight/2}function L(){}function S(t,e,n){return function(){if(-1!=A&&A!=M.list.length-1){var t=E.chapter.scrollTop;e-t<=1.2*n&&e-t>0&&(E.chapter.onscroll=L,k(M.list[A+1].id))}}}function w(){return fetch("/list").then(function(t){return t.json()}).then(function(t){j=t,b(),h(t),c()})}var C=null,j=null,M=null,H=null,N=function(t,e){return 1},R=0,A=0,O=function(t){return document.querySelector(t)},U={home:O(".tool-home"),index:O(".tool-index"),option:O(".tool-option"),top:O(".tool-top"),prev:O(".tool-prev"),next:O(".tool-next"),add:O(".tool-add")},E={tool:O("#tool"),home:O("#home"),index:O("#index"),chapter:O("#chapter"),list:O("#list"),bookList:O("ol.books"),classify:O(".classify"),bookMeta:O(".book-meta"),listCounts:O(".list-counts"),listContent:O(".list-content"),listRule:O(".list-rule"),TagClasses:O(".classes-tag"),TagStatus:O(".status-tag"),TagTimes:O(".times-tag"),TagSort:O(".sort-tag"),sortLabels:function(t){return document.querySelectorAll(t)}(".sort-tag > label"),chapterPage:O(".chapter-page"),chapterContainer:O(".chapter-container"),chapterList:O(".chapter-list"),chapterIndex:O(".home-page"),chapterPrev:O(".prev-page"),chapterNext:O(".next-page"),bookReload:O(".book-reload"),bookEpub:O(".book-epub"),bookUpdate:O(".book-update"),bookDelete:O(".book-delete"),bookEnd:O(".book-end"),overlay:O("#overlay"),searchText:O("#search-text"),searchBtn:O("#search-btn")},q={get:function(t){return localStorage.getItem(t)},set:function(t,e){return localStorage.setItem(t,e)},del:function(t){return localStorage.removeItem(t)},default:function(t,e){var n=localStorage.getItem(t);return null!==n?n:(localStorage.setItem(t,e),e)}};!function(){fetch("src/sort.svg").then(function(t){return t.text()}).then(function(t){e(E.sortLabels,function(e){return e.innerHTML+=t})}),Object.keys(U).forEach(function(t){fetch("src/"+t+".svg").then(function(t){return t.text()}).then(function(e){U[t].innerHTML='<a class="flow-tool">'+e+"</a>"})})}(),function(){U.option.onclick=function(){r(E.bookList,E.classify)},U.top.onclick=function(){"none"!=E.home.style.display&&E.home.scrollTo(0,0),"none"!=E.index.style.display&&E.index.scrollTo(0,0),"none"!=E.chapter.style.display&&E.chapter.scrollTo(0,0)},U.home.onclick=c,U.index.onclick=function(){"list"==C?l():u(),x()},U.add.onclick=function(){var t=prompt("请输入小说地址：");if(t){o(E.overlay);var e=setTimeout(function(){i(E.overlay)},5e3);fetch("/add/"+encodeURIComponent(t),{method:"POST"}).then(function(t){return t.json()}).then(function(t){j=t,b(),h(t),c(),i(E.overlay),clearTimeout(e)})}},E.chapterIndex.onclick=function(){a(),E.index.scrollTo(0,0)},E.chapterPrev.onclick=U.prev.onclick=function(){if(-1!=A)return 0==A?a():void T(M.list[A-1].id)},E.chapterNext.onclick=U.next.onclick=function(){if(-1!=A)return A==M.list.length-1?a():void T(M.list[A+1].id)},E.bookList.onclick=n(["div","img","h2"],function(t){var e=t.getAttribute("uuid");if(e)return g(e)}),E.listRule.onclick=function(){"倒序"==this.innerText?this.innerText="正序":this.innerText="倒序";var t=E.listContent.innerHTML,e=t.split("</li>").reverse();e.shift(),E.listContent.innerHTML=e.join("</li>")+"</li>"},E.listContent.onclick=n("li",function(t){var e=t.getAttribute("cid");if(e)return T(e)}),E.chapterList.onclick=n("li",function(t){var e=t.getAttribute("cid");if(e)return T(e)});var t={"默认":function(t,e){return 1},"书名":function(t,e){return t.title>e.title?1:-1},"作者":function(t,e){return t.author>e.author?1:-1},"分类":function(t,e){return t.classes>e.classes?1:-1},"更新时间":function(t,e){return t.date-e.date}},s=q.default("sort-type","默认"),d=q.default("sort-value","1"),p=t[s];N=function(t,e){return d*p(t,e)},e(E.sortLabels,function(t){if(t.innerText==s)return t.className="1"==d?"tab tab-selected tab-up":"tab tab-selected tab-down";t.className="tab"}),E.TagSort.onclick=n("label",function(n){var o=n.innerText,i=q.default("sort-type","默认"),r=q.default("sort-value","1");e(E.sortLabels,function(t){return n!==t&&(t.className="tab")}),i==o?(n.className="tab tab-selected tab-down",q.set("sort-value","-1"),r=-1):(n.className="tab tab-selected tab-up",q.set("sort-type",o),q.set("sort-value","1"),r=1);var c=t[o];N=function(t,e){return r*c(t,e)},h(H),U.option.click()}),E.searchBtn.onclick=function(){var t=E.searchText.value;t&&(h(j.filter(function(e){return e.title.match(t)||e.author.match(t)||e.classes.match(t)||e.brief.match(t)})),U.option.click())},E.bookReload.onclick=function(){return g(M.meta.uuid,!0)},E.bookEpub.onclick=function(){fetch("/ebook/"+M.meta.uuid).then(function(t){return t.blob().then(function(e){var n=t.headers.get("Content-Disposition").match(/filename="(.*)"/)[1];if(void 0!==window.navigator.msSaveBlob)return window.navigator.msSaveBlob(e,n);var o=window.URL&&window.URL.createObjectURL?window.URL.createObjectURL(e):window.webkitURL.createObjectURL(e),i=document.createElement("a");i.style.display="none",i.href=o,i.setAttribute("download",n),void 0===i.download&&i.setAttribute("target","_blank"),document.body.appendChild(i),i.click(),setTimeout(function(){document.body.removeChild(i),window.URL.revokeObjectURL(o)},200)})})},E.bookUpdate.onclick=function(){f(function(){return fetch("/update/"+M.meta.uuid,{method:"POST"}).then(function(t){return t.json()}).then(function(t){return t.code&&g(M.meta.uuid,!0)})})},E.bookDelete.onclick=function(){f(function(){return fetch("/delete/"+M.meta.uuid,{method:"POST"}).then(function(t){return t.json()}).then(function(t){q.del(M.meta.uuid),M=null,j=t,b(),h(t),c()})})},E.bookEnd.onclick=function(){f(function(){return fetch("/end/"+M.meta.uuid,{method:"POST"}).then(function(t){return t.json()}).then(function(t){return g(M.meta.uuid,!0)})})},E.overlay.addEventListener("touchmove",function(t){t.preventDefault()})}(),f(w)}init();