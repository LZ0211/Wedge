"use strict";function init(){function t(t,e,n){if(t=""+t,t.length>=n)return t;for(var o=t.length;o<n;o++)t=e+t;return t}function e(e,n){var o=new Date(e),i=n||"yyyy-MM-dd";return i=i.replace(/(y+)/,function(e,n){return t(o.getFullYear(),0,n.length)}),i=i.replace(/(M+)/,function(e,n){return t(o.getMonth()+1,0,n.length)}),i=i.replace(/(d+)/,function(e,n){return t(o.getDate(),0,n.length)}),i=i.replace(/(h+)/,function(e,n){return t(o.getHours(),0,n.length)}),i=i.replace(/(m+)/,function(e,n){return t(o.getMinutes(),0,n.length)}),i=i.replace(/(s+)/,function(e,n){return t(o.getSeconds(),0,n.length)})}function n(t){var e="<div class='child'>"+t+"</div>",n=document.createElement("div");return n.innerHTML=e,n.firstChild}function o(t,e){for(var n=0;n<t.length;n++)e(t[n],n,t)}function i(t,e){return function(n){var n=n||window.event,o=n.target||n.srcElement,i=o.tagName.toLowerCase();if(Array.isArray(t)){if(~t.indexOf(i))return e(o)}else if(i==t.toLowerCase())return e(o)}}function c(){o(arguments,function(t){return t.style.display="block"})}function r(){o(arguments,function(t){return t.style.display="none"})}function l(){[].forEach.call(arguments,function(t){"none"===t.style.display?t.style.display="block":t.style.display="none"})}function a(){c(E.tool,E.home,q.option,q.top,q.add,q.refresh),r(E.index,E.chapter,q.prev,q.next,q.index,q.home),w="home"}function u(){c(E.tool,E.index,q.home,q.top),r(E.home,E.chapter,q.index,q.prev,q.next,q.option,q.add,q.refresh),w="index"}function s(){c(E.tool,E.chapter,q.prev,q.next,q.index,q.home,q.top),r(E.home,E.index,q.option,q.add,q.refresh),w="chapter"}function d(t,e){e=e||5e3,c(E.overlay);var n=setTimeout(function(){r(E.overlay)},e),o=t();if(o&&o.then)return o.then(function(){r(E.overlay),clearTimeout(n)});r(E.overlay),clearTimeout(n)}function f(t){H=t.sort(N),E.bookList.innerHTML=t.map(function(t){return'<li class="book-li" uuid="'+t.uuid+'"><div class="book-layout"><img src="/cover/'+t.uuid+'" class="book-cover" alt="'+t.title+'" uuid="'+t.uuid+'"><div class="book-cell"><div class="book-title-x"><h2 class="book-title" uuid="'+t.uuid+'">'+t.title+'</h2><span class="book-date">'+e(t.date)+'</span></div><div class="book-author">作者：'+t.author+'</div><div class="book-classes">分类：'+t.classes+'</div><div class="book-status">更新状态：'+(t.isend?"完结":"连载")+"</div></div></li>"}).join(""),E.home.scrollTop=0}function h(){E.bookMeta.innerHTML='<div class="book-layout" uuid="'+M.meta.uuid+'"><img src="/cover/'+M.meta.uuid+'" class="book-cover"><div class="book-cell"><div class="book-title-x"><h2 class="book-title">'+M.meta.title+'</h2><span class="book-date">'+e(M.meta.date)+'</span></div><div class="book-author">作者：'+M.meta.author+'</div><div class="book-classes">分类：'+M.meta.classes+'</div><div class="book-status">更新状态：'+(M.meta.isend?"完结":"连载")+'</div></div></div><div class="book-brief"><p>'+M.meta.brief.replace(/\n/g,"</p><p>")+"</p></div>",E.listCounts.innerText="共"+M.list.length+"章",E.listRule.innerText=A>0?"正序":"倒序",E.listContent.innerHTML=M.list.map(function(t){return'<li cid="'+t.id+'">'+t.title+"</li>"}).join(""),E.index.scrollTop=0}function p(){function t(t,e){var n=t.innerText,i=e[n];if(i){if("tab tab-selected"==t.className&&H.length==i.length)return q.option.click();o(E.TagStatus.querySelectorAll("label"),function(t){return t.className="tab"}),o(E.TagClasses.querySelectorAll("label"),function(t){return t.className="tab"}),o(E.TagTimes.querySelectorAll("label"),function(t){return t.className="tab"}),t.className="tab tab-selected",f(i),q.option.click()}}var e=j.concat(),n={"全部":e},c={"全部":e,"完结":[],"连载":[]},r={"全部":e,"一日内":[],"一周内":[],"一月内":[],"半年内":[],"半年外":[]},l=Date.now();j.forEach(function(t){t.classes in n?n[t.classes].push(t):n[t.classes]=[t],t.status=t.isend?"完结":"连载",c[t.status].push(t);var e=l-t.date;e<864e5?(r["一日内"].push(t),r["一周内"].push(t),r["一月内"].push(t),r["半年内"].push(t)):e<6048e5?(r["一周内"].push(t),r["一月内"].push(t),r["半年内"].push(t)):e<2592e6?(r["一月内"].push(t),r["半年内"].push(t)):e<15552e6?r["半年内"].push(t):r["半年外"].push(t)}),E.TagClasses.innerHTML=Object.keys(n).map(function(t){return'<label class="tab">'+t+"</label>"}).join(""),E.TagStatus.innerHTML=Object.keys(c).map(function(t){return'<label class="tab">'+t+"</label>"}).join(""),E.TagTimes.innerHTML=Object.keys(r).map(function(t){return'<label class="tab">'+t+"</label>"}).join(""),E.TagClasses.querySelector("label").className="tab tab-selected",E.TagClasses.onclick=i("label",function(e){return t(e,n)}),E.TagStatus.onclick=i("label",function(e){return t(e,c)}),E.TagTimes.onclick=i("label",function(e){return t(e,r)})}function b(t){E.chapterContainer.innerHTML='<h3 class="chapter-title" cid="'+t.id+'">'+t.title+'</h3><div class="chapter-content"><p>'+t.content.replace(/\n/g,"</p><p>")+"</p></div>"}function m(t){document.createDocumentFragment(),E.chapterContainer.appendChild(n('<h3 class="chapter-title" cid="'+t.id+'">'+t.title+"</h3>")),E.chapterContainer.appendChild(n('<div class="chapter-content"><p>'+t.content.replace(/\n/g,"</p><p>")+"</p></div>"))}function v(t){var e=T(t);if(-1!=e&&!(e<=O))return O=e,R=t,(E.listContent.querySelector(".selected")||{}).className="",E.listContent.querySelectorAll("li")[O].className="selected",fetch("/chapter/"+M.meta.uuid+"/"+t).then(function(t){return t.json()}).then(function(e){O=T(R),m(e),S.set(M.meta.uuid,t)}).then(function(){return setTimeout(function(){return E.chapter.onscroll=x(O,E.chapter.scrollHeight,E.chapter.clientHeight)},100)})}function k(t,e){if(S.set("book",t),!e&&M&&M.meta.uuid==t){var n=S.get(M.meta.uuid);return n?g(n):(u(),void(E.index.scrollTop=0))}d(function(){var n=e?{cache:"reload"}:{};return fetch("/book/"+t,n).then(function(t){return t.json()}).then(function(t){M=t,M.list.sort(function(t,e){return A*(t.id-e.id)}),h();var n=S.get(M.meta.uuid);if(n&&!e)return g(n);u(),E.index.scrollTop=0})})}function g(t){if(-1!=T(t))return R=t,O=T(R),(E.listContent.querySelector(".selected")||{}).className="",E.listContent.querySelectorAll("li")[O].className="selected",fetch("/chapter/"+M.meta.uuid+"/"+t).then(function(t){return t.json()}).then(function(e){b(e),s(),E.chapter.scrollTop=0,S.set(M.meta.uuid,t)}).then(function(){return setTimeout(function(){return E.chapter.onscroll=x(O,E.chapter.scrollHeight,E.chapter.clientHeight)},100)})}function T(t){for(var e=M.list,n=0,o=e.length-1;n<=o;){var i=Math.floor((o+n)/2);if(e[i].id==t)return i;if(e[i].id-t<0)n=i+1;else{if(!(e[i].id-t>0))return-1;o=i-1}}}function y(){}function x(t,e,n){return function(){if(-1!=O&&O!=M.list.length-1){var t=E.chapter.scrollTop;e-t<=1.2*n&&e-t>0&&(E.chapter.onscroll=y,v(M.list[O+1].id))}}}function L(){return fetch("/list").then(function(t){return t.json()}).then(function(t){j=t,p(),f(t);var e=S.get("book");e?k(e):a()})}var S={get:function(t){return localStorage.getItem(t)},set:function(t,e){return localStorage.setItem(t,e)},del:function(t){return localStorage.removeItem(t)},default:function(t,e){var n=localStorage.getItem(t);return null!==n?n:(localStorage.setItem(t,e),e)}},C=document,w=null,j=null,M=null,H=null,N=function(t,e){return 1},R=0,O=0,A=S.default("list_sort",1),U=function(t){return C.querySelector(t)},q={home:U(".tool-home"),index:U(".tool-index"),option:U(".tool-option"),top:U(".tool-top"),prev:U(".tool-prev"),next:U(".tool-next"),add:U(".tool-add"),refresh:U(".tool-refresh")},E={tool:U("#tool"),home:U("#home"),index:U("#index"),chapter:U("#chapter"),bookList:U("ol.books"),classify:U(".classify"),bookMeta:U(".book-meta"),listCounts:U(".list-counts"),listContent:U(".list-content"),listRule:U(".list-rule"),TagClasses:U(".classes-tag"),TagStatus:U(".status-tag"),TagTimes:U(".times-tag"),TagSort:U(".sort-tag"),sortLabels:function(t){return C.querySelectorAll(t)}(".sort-tag > label"),chapterPage:U(".chapter-page"),chapterContainer:U(".chapter-container"),chapterIndex:U(".home-page"),chapterPrev:U(".prev-page"),chapterNext:U(".next-page"),bookReload:U(".book-reload"),bookEpub:U(".book-epub"),bookUpdate:U(".book-update"),bookDelete:U(".book-delete"),bookEnd:U(".book-end"),overlay:U("#overlay"),searchText:U("#search-text"),searchBtn:U("#search-btn")};!function(){fetch("src/sort.svg").then(function(t){return t.text()}).then(function(t){o(E.sortLabels,function(e){return e.innerHTML+=t})}),Object.keys(q).forEach(function(t){fetch("src/"+t+".svg").then(function(t){return t.text()}).then(function(e){q[t].innerHTML='<a class="flow-tool">'+e+"</a>"})})}(),function(){q.option.onclick=function(){l(E.bookList,E.classify)},q.top.onclick=function(){E[w].scrollTo(0,0)},q.home.onclick=function(){a(),S.del("book")},q.refresh.onclick=function(){return location.reload()},q.index.onclick=function(){var t=E.listContent.querySelector(".selected");u(),E.index.scrollTop=t.offsetTop-E.index.clientHeight/2},q.add.onclick=function(){var t=prompt("请输入小说地址：");t&&d(function(){fetch("/add/"+encodeURIComponent(t),{method:"POST"}).then(function(t){return t.json()}).then(function(t){j=t,p(),f(t),a()})},1e4)},E.chapterIndex.onclick=function(){u(),E.index.scrollTo(0,0)},E.chapterPrev.onclick=q.prev.onclick=function(){if(-1!=O)return 0==O?u():void g(M.list[O-1].id)},E.chapterNext.onclick=q.next.onclick=function(){if(-1!=O)return O==M.list.length-1?u():void g(M.list[O+1].id)},E.bookList.onclick=i(["li","img","h2"],function(t){var e=t.getAttribute("uuid");if(e)return k(e)}),E.listRule.onclick=function(){A*=-1,S.set("list_sort",A),M.list.sort(function(t,e){return A*(t.id-e.id)}),h()},E.listContent.onclick=i("li",function(t){var e=t.getAttribute("cid");return e==R?s():g(e)});var t={"默认":function(t,e){return 1},"书名":function(t,e){return t.title>e.title?1:-1},"作者":function(t,e){return t.author>e.author?1:-1},"分类":function(t,e){return t.classes>e.classes?1:-1},"更新时间":function(t,e){return t.date-e.date}},e=S.default("sort-type","默认"),n=S.default("sort-value","1"),c=t[e];N=function(t,e){return n*c(t,e)},o(E.sortLabels,function(t){if(t.innerText==e)return t.className="1"==n?"tab tab-selected tab-up":"tab tab-selected tab-down";t.className="tab"}),E.TagSort.onclick=i("label",function(e){var n=e.innerText,i=S.default("sort-type","默认"),c=S.default("sort-value","1");o(E.sortLabels,function(t){return e!==t&&(t.className="tab")}),i==n?(e.className="tab tab-selected tab-down",S.set("sort-value","-1"),c=-1):(e.className="tab tab-selected tab-up",S.set("sort-type",n),S.set("sort-value","1"),c=1);var r=t[n];N=function(t,e){return c*r(t,e)},f(H),q.option.click()}),E.searchBtn.onclick=function(){var t=E.searchText.value;t&&(f(j.filter(function(e){return e.title.match(t)||e.author.match(t)||e.classes.match(t)||e.brief.match(t)})),q.option.click())},E.bookReload.onclick=function(){return k(M.meta.uuid,!0)},E.bookEpub.onclick=function(){fetch("/ebook/"+M.meta.uuid).then(function(t){return t.blob().then(function(e){var n=t.headers.get("Content-Disposition").match(/filename="(.*)"/)[1];if(void 0!==window.navigator.msSaveBlob)return window.navigator.msSaveBlob(e,n);var o=window.URL&&window.URL.createObjectURL?window.URL.createObjectURL(e):window.webkitURL.createObjectURL(e),i=document.createElement("a");i.style.display="none",i.href=o,i.setAttribute("download",n),void 0===i.download&&i.setAttribute("target","_blank"),document.body.appendChild(i),i.click(),setTimeout(function(){document.body.removeChild(i),window.URL.revokeObjectURL(o)},200)})})},E.bookUpdate.onclick=function(){d(function(){return fetch("/update/"+M.meta.uuid,{method:"POST"}).then(function(t){return t.json()}).then(function(t){return t.code&&k(M.meta.uuid,!0)})})},E.bookDelete.onclick=function(){d(function(){return fetch("/delete/"+M.meta.uuid,{method:"POST"}).then(function(t){return t.json()}).then(function(t){S.del(M.meta.uuid),M=null,j=t,p(),f(t),a()})})},E.bookEnd.onclick=function(){d(function(){return fetch("/end/"+M.meta.uuid,{method:"POST"}).then(function(t){return t.json()}).then(function(t){return k(M.meta.uuid,!0)})})},E.tool.ontouchstart=function(t){var e=this.clientHeight,n=t.touches[0].clientY-this.offsetTop,o=document.body.clientHeight-e;this.ontouchmove=function(t){t.preventDefault(),E[w].style.cssText="overflow:hidden;",this.style.bottom=o-Math.min(Math.max(1,t.touches[0].clientY-n),o-1)+"px"}},E.tool.ontouchend=function(){this.ontouchmove=null,E[w].style.cssText="",S.set("float_bottom",this.style.bottom)},E.tool.style.bottom=S.default("float_bottom","10px"),E.home.ontouchstart=E.index.ontouchstart=E.chapter.ontouchstart=function(){this.style.cssText=""},E.overlay.addEventListener("touchmove",function(t){t.preventDefault()})}(),d(L)}init();