"use strict";function init(){function t(t){var e=document.createElement("div");return e.innerHTML=t,e.childNodes[0]}function e(t,e,n){if(t=""+t,t.length>=n)return t;for(var o=t.length;o<n;o++)t=e+t;return t}function n(t,n){var o=new Date(t),i=n||"yyyy-MM-dd";return i=i.replace(/(y+)/,function(t,n){return e(o.getFullYear(),0,n.length)}),i=i.replace(/(M+)/,function(t,n){return e(o.getMonth()+1,0,n.length)}),i=i.replace(/(d+)/,function(t,n){return e(o.getDate(),0,n.length)}),i=i.replace(/(h+)/,function(t,n){return e(o.getHours(),0,n.length)}),i=i.replace(/(m+)/,function(t,n){return e(o.getMinutes(),0,n.length)}),i=i.replace(/(s+)/,function(t,n){return e(o.getSeconds(),0,n.length)})}function o(t){var e={};return i(t,function(t){return e[t]=1}),e}function i(t,e){for(var n=0;n<t.length;n++)e(t[n],n,t)}function r(t,e){return function(n){var n=n||window.event,o=n.target||n.srcElement,i=o.tagName.toLowerCase();if(Array.isArray(t)){if(~t.indexOf(i))return e(o)}else if(i==t.toLowerCase())return e(o)}}function c(){i(arguments,function(t){return t.style.display="block"})}function l(){i(arguments,function(t){return t.style.display="none"})}function a(){[].forEach.call(arguments,function(t){"none"===t.style.display?t.style.display="block":t.style.display="none"})}function u(){c(D.tool,D.home,q.option,q.add,q.refresh),l(D.index,D.chapter,q.prev,q.next,q.index,q.home,q.top,q.bottom),j="home",S.del("book")}function s(){c(D.tool,D.index,q.home,q.top,q.bottom),l(D.home,D.chapter,q.index,q.prev,q.next,q.option,q.add,q.refresh),j="index"}function d(){c(D.tool,D.chapter,q.prev,q.next,q.index,q.home),l(D.home,D.index,q.option,q.add,q.refresh,q.top,q.bottom),j="chapter"}function f(t,e){e=e||5e3,c(D.overlay);var n=setTimeout(function(){l(D.overlay)},e),o=t();if(o&&o.then)return o.then(function(){l(D.overlay),clearTimeout(n)});l(D.overlay),clearTimeout(n)}function h(t){function e(t,e){return t.uuid in i&&e.uuid in i?O(t,e):t.uuid in i?-1:e.uuid in i?1:O(t,e)}var i=o(JSON.parse(S.get("tops")||"[]"));H=t.sort(e),D.bookList.innerHTML=t.map(function(t){return'<li class="book-li" uuid="'+t.uuid+'"><div class="book-layout"><img src="/cover/'+t.uuid+'" class="book-cover" alt="'+t.title+'" uuid="'+t.uuid+'"><div class="book-cell"><div class="book-title-x"><h2 class="book-title" uuid="'+t.uuid+'">'+t.title+'</h2><span class="book-date">'+n(t.date)+'</span></div><div class="book-author">作者：'+t.author+'</div><div class="book-classes">分类：'+t.classes+'</div><div class="book-status">更新状态：'+(t.isend?"完结":"连载")+"</div></div></li>"}).join(""),D.home.scrollTop=0}function p(){D.bookMeta.innerHTML='<div class="book-layout" uuid="'+N.meta.uuid+'"><img src="/cover/'+N.meta.uuid+'" class="book-cover"><div class="book-cell"><div class="book-title-x"><h2 class="book-title">'+N.meta.title+'</h2><span class="book-date">'+n(N.meta.date)+'</span></div><div class="book-author">作者：'+N.meta.author+'</div><div class="book-classes">分类：'+N.meta.classes+'</div><div class="book-status">更新状态：'+(N.meta.isend?"完结":"连载")+'</div></div></div><div class="book-brief"><p>'+N.meta.brief.replace(/\n/g,"</p><p>")+"</p></div>",D.listCounts.innerText="共"+N.list.length+"章",D.listRule.innerText=U>0?"正序":"倒序",D.listContent.innerHTML=(U>0?N.list:N.list.concat().reverse()).map(function(t){return'<li cid="'+t.id+'">'+t.title+"</li>"}).join(""),D.index.scrollTop=0;var t=o(JSON.parse(S.get("tops")||"[]"));D.bookLike.innerText=N.meta.uuid in t?"已收藏":"收藏"}function b(){function t(t,e){var n=t.innerText,o=e[n];if(o){if("tab tab-selected"==t.className&&H.length==o.length)return q.option.click();i(D.TagStatus.querySelectorAll("label"),function(t){return t.className="tab"}),i(D.TagClasses.querySelectorAll("label"),function(t){return t.className="tab"}),i(D.TagTimes.querySelectorAll("label"),function(t){return t.className="tab"}),t.className="tab tab-selected",h(o),q.option.click()}}var e=M.concat(),n={"全部":e},o={"全部":e,"完结":[],"连载":[]},c={"全部":e,"一日内":[],"一周内":[],"一月内":[],"半年内":[],"半年外":[]},l=Date.now();M.forEach(function(t){t.classes in n?n[t.classes].push(t):n[t.classes]=[t],t.status=t.isend?"完结":"连载",o[t.status].push(t);var e=l-t.date;e<864e5?(c["一日内"].push(t),c["一周内"].push(t),c["一月内"].push(t),c["半年内"].push(t)):e<6048e5?(c["一周内"].push(t),c["一月内"].push(t),c["半年内"].push(t)):e<2592e6?(c["一月内"].push(t),c["半年内"].push(t)):e<15552e6?c["半年内"].push(t):c["半年外"].push(t)}),D.TagClasses.innerHTML=Object.keys(n).map(function(t){return'<label class="tab">'+t+"</label>"}).join(""),D.TagStatus.innerHTML=Object.keys(o).map(function(t){return'<label class="tab">'+t+"</label>"}).join(""),D.TagTimes.innerHTML=Object.keys(c).map(function(t){return'<label class="tab">'+t+"</label>"}).join(""),D.TagClasses.querySelector("label").className="tab tab-selected",D.TagClasses.onclick=r("label",function(e){return t(e,n)}),D.TagStatus.onclick=r("label",function(e){return t(e,o)}),D.TagTimes.onclick=r("label",function(e){return t(e,c)})}function m(t){D.chapterContainer.innerHTML='<h3 class="chapter-title" cid="'+t.id+'">'+t.title+'</h3><div class="chapter-content"><p>'+t.content.replace(/\n/g,"</p><p>")+"</p></div>"}function v(e){D.chapterContainer.appendChild(t('<h3 class="chapter-title" cid="'+e.id+'">'+e.title+"</h3>")),D.chapterContainer.appendChild(t('<div class="chapter-content"><p>'+e.content.replace(/\n/g,"</p><p>")+"</p></div>"))}function k(t,e){if(S.set("book",t),!e&&N&&N.meta.uuid==t){var n=S.get(N.meta.uuid);return n?g(n):(s(),void(D.index.scrollTop=0))}R=null,f(function(){var n=e?{cache:"reload"}:{};return fetch("/book/"+t,n).then(function(t){return t.json()}).then(function(t){N=t,N.list.sort(function(t,e){return t.id-e.id}),p();var n=S.get(N.meta.uuid);if(n&&!e)return g(n);s(),D.index.scrollTop=0})})}function g(t,e){console.log(t);var n=T(t);if(-1!=n){R=t,E=n,(D.listContent.querySelector(".selected")||{}).className="";var o=U>0?E:N.list.length-1-E;return D.listContent.querySelectorAll("li")[o].className="selected",fetch("/chapter/"+N.meta.uuid+"/"+t).then(function(t){return t.json()}).then(function(n){e?v(n):(m(n),d(),D.chapter.scrollTop=0),S.set(N.meta.uuid,t)}).then(function(){return setTimeout(function(){return D.chapter.onscroll=x(E,D.chapter.scrollHeight,D.chapter.clientHeight)},100)})}}function T(t){for(var e=N.list,n=0,o=e.length-1;n<=o;){var i=Math.floor((o+n)/2);if(e[i].id==t)return i;if(e[i].id-t<0)n=i+1;else{if(!(e[i].id-t>0))return-1;o=i-1}}}function y(){}function x(t,e,n){return function(){if(-1!=E&&E!=N.list.length-1){var t=D.chapter.scrollTop;e-t<=1.5*n&&e-t>0&&(D.chapter.onscroll=y,g(N.list[E+1].id,!0))}}}function L(){return fetch("/list").then(function(t){return t.json()}).then(function(t){M=t,b(),h(t);var e=S.get("book");e?k(e):u()})}var S={get:function(t){return localStorage.getItem(t)},set:function(t,e){return localStorage.setItem(t,e)},del:function(t){return localStorage.removeItem(t)},default:function(t,e){var n=localStorage.getItem(t);return null!==n?n:(localStorage.setItem(t,e),e)}},w=document,C=function(){try{return document.createEvent("TouchEvent"),!0}catch(t){return!1}}(),j=null,M=null,N=null,H=null,O=function(t,e){return 1},R=null,E=0,U=S.default("list_sort",1),A=function(t){return w.querySelector(t)},q={home:A(".tool-home"),index:A(".tool-index"),option:A(".tool-option"),top:A(".tool-top"),prev:A(".tool-prev"),next:A(".tool-next"),add:A(".tool-add"),refresh:A(".tool-refresh"),bottom:A(".tool-bottom")},D={tool:A("#tool"),home:A("#home"),index:A("#index"),chapter:A("#chapter"),bookList:A("ol.books"),classify:A(".classify"),bookMeta:A(".book-meta"),listCounts:A(".list-counts"),listContent:A(".list-content"),listRule:A(".list-rule"),TagClasses:A(".classes-tag"),TagStatus:A(".status-tag"),TagTimes:A(".times-tag"),TagSort:A(".sort-tag"),sortLabels:function(t){return w.querySelectorAll(t)}(".sort-tag > label"),chapterPage:A(".chapter-page"),chapterContainer:A(".chapter-container"),chapterIndex:A(".home-page"),chapterPrev:A(".prev-page"),chapterNext:A(".next-page"),bookReload:A(".book-reload"),bookEpub:A(".book-epub"),bookUpdate:A(".book-update"),bookDelete:A(".book-delete"),bookEnd:A(".book-end"),bookLike:A(".book-like"),overlay:A("#overlay"),searchText:A("#search-text"),searchBtn:A("#search-btn")};!function(){fetch("src/sort.svg").then(function(t){return t.text()}).then(function(t){i(D.sortLabels,function(e){return e.innerHTML+=t})}),Object.keys(q).forEach(function(t){fetch("src/"+t+".svg").then(function(t){return t.text()}).then(function(e){q[t].innerHTML='<a class="flow-tool">'+e+"</a>"})})}(),function(){q.option.onclick=function(){a(D.bookList,D.classify)},q.top.onclick=function(){D[j].scrollTo(0,0)},q.bottom.onclick=function(){D[j].scrollTo(0,D[j].scrollHeight)},q.home.onclick=u,q.refresh.onclick=location.reload.bind(location),q.index.onclick=function(){var t=D.listContent.querySelector(".selected");s(),D.index.scrollTop=t.offsetTop-D.index.clientHeight/2},q.add.onclick=function(){var t=prompt("请输入小说地址：");t&&f(function(){fetch("/add/"+encodeURIComponent(t),{method:"POST"}).then(function(t){return t.json()}).then(function(t){M=t,b(),h(t),u()})},1e4)},D.chapterIndex.onclick=function(){s(),D.index.scrollTo(0,0)},D.chapterPrev.onclick=q.prev.onclick=function(){if(-1!=E)return 0==E?s():void g(N.list[E-1].id)},D.chapterNext.onclick=q.next.onclick=function(){if(-1!=E)return E==N.list.length-1?s():void g(N.list[E+1].id)},D.bookList.onclick=r(["li","img","h2"],function(t){var e=t.getAttribute("uuid");if(e)return k(e)}),D.listRule.onclick=function(){U*=-1,S.set("list_sort",U);var t=D.listContent.innerHTML,e=t.split("</li>").reverse();e.shift(),D.listContent.innerHTML=e.join("</li>")+"</li>"},D.listContent.onclick=r("li",function(t){var e=t.getAttribute("cid");return e==R?d():g(e)});var t={"默认":function(t,e){return 1},"书名":function(t,e){return t.title>e.title?1:-1},"作者":function(t,e){return t.author>e.author?1:-1},"分类":function(t,e){return t.classes>e.classes?1:-1},"更新时间":function(t,e){return t.date-e.date}},e=S.default("sort-type","默认"),n=S.default("sort-value","1"),p=t[e];O=function(t,e){return n*p(t,e)},i(D.sortLabels,function(t){if(t.innerText==e)return t.className="1"==n?"tab tab-selected tab-up":"tab tab-selected tab-down";t.className="tab"}),D.TagSort.onclick=r("label",function(e){var n=e.innerText,o=S.default("sort-type","默认"),r=S.default("sort-value","1");i(D.sortLabels,function(t){return e!==t&&(t.className="tab")}),o==n?(e.className="tab tab-selected tab-down",S.set("sort-value","-1"),r=-1):(e.className="tab tab-selected tab-up",S.set("sort-type",n),S.set("sort-value","1"),r=1);var c=t[n];O=function(t,e){return r*c(t,e)},h(H),q.option.click()}),D.searchBtn.onclick=function(){var t=D.searchText.value;t&&(h(M.filter(function(e){return e.title.match(t)||e.author.match(t)||e.classes.match(t)||e.brief.match(t)})),q.option.click())},D.bookReload.onclick=function(){return k(N.meta.uuid,!0)},D.bookEpub.onclick=function(){fetch("/ebook/"+N.meta.uuid).then(function(t){return t.blob().then(function(e){var n=t.headers.get("Content-Disposition").match(/filename="(.*)"/)[1];if(void 0!==window.navigator.msSaveBlob)return window.navigator.msSaveBlob(e,n);var o=window.URL&&window.URL.createObjectURL?window.URL.createObjectURL(e):window.webkitURL.createObjectURL(e),i=document.createElement("a");i.style.display="none",i.href=o,i.setAttribute("download",n),void 0===i.download&&i.setAttribute("target","_blank"),document.body.appendChild(i),i.click(),setTimeout(function(){document.body.removeChild(i),window.URL.revokeObjectURL(o)},200)})})},(C?l:c)(D.bookEpub),D.bookUpdate.onclick=function(){f(function(){return fetch("/update/"+N.meta.uuid,{method:"POST"}).then(function(t){return t.json()}).then(function(t){return t.code&&k(N.meta.uuid,!0)})})},D.bookDelete.onclick=function(){f(function(){return fetch("/delete/"+N.meta.uuid,{method:"POST"}).then(function(t){return t.json()}).then(function(t){S.del(N.meta.uuid),N=null,M=t,b(),h(t),u()})})},D.bookEnd.onclick=function(){f(function(){return fetch("/end/"+N.meta.uuid,{method:"POST"}).then(function(t){return t.json()}).then(function(t){return k(N.meta.uuid,!0)})})},D.bookLike.onclick=function(){var t=o(JSON.parse(S.get("tops")||"[]"));t[N.meta.uuid]=1,S.set("tops",JSON.stringify(Object.keys(t))),D.bookLike.innerText="已收藏"},D.tool.ontouchstart=function(t){var e=this.clientHeight,n=t.touches[0].clientY-this.offsetTop,o=document.body.clientHeight-e;this.ontouchmove=function(t){t.preventDefault(),D[j].style.cssText="overflow:hidden;",this.style.bottom=o-Math.min(Math.max(1,t.touches[0].clientY-n),o-1)+"px"}},D.tool.ontouchend=function(){this.ontouchmove=null,D[j].style.cssText="",S.set("float_bottom",this.style.bottom)},D.tool.style.bottom=S.default("float_bottom","10px"),D.home.ontouchstart=D.index.ontouchstart=D.chapter.ontouchstart=function(){this.style.cssText=""},D.overlay.touchmove=function(t){t.preventDefault()}}(),f(L)}init();